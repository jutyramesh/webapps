#
# Azure State Repository - Deployment Pipeline
#
trigger:
- main


jobs:
#
# Non-Production Deployment Job
#
- job: NprodDeployment
  pool: wh-np-ccp-agents
  timeoutInMinutes: 720
  steps:
  - task: PowerShell@2
    displayName: Identify State Changes
    inputs:
      pwsh: true
      targetType: filePath
      filePath: pipeline/Build-EnvironmentLists.ps1
      arguments: -Environments "sandbox", "nprod_management", "nprod_datalynx", "nprod_datascience"

  #
  # Sandbox Deployments
  #
  - task: AzureCLI@2
    displayName: Sandbox Environment Deployments
    timeoutInMinutes: 360
    inputs:
      azureSubscription: wh-np-ccp-connection
      scriptType: pscore
      scriptPath: pipeline/Deploy-EnvironmentUpdates.ps1
      arguments: -DeploymentList "$(sandbox)"

  #
  # Non-Production Management Plane Environment
  #
  - task: AzureCLI@2
    displayName: NPROD Management Environment Validation
    inputs:
      azureSubscription: wh-np-ccp-connection
      scriptType: pscore
      scriptPath: pipeline/Validate-EnvironmentUpdates.ps1
      arguments: -DeploymentList "$(nprod_management)"

  - task: AzureCLI@2
    displayName: NPROD Management Environment Deployments
    timeoutInMinutes: 360
    inputs:
      azureSubscription: wh-np-ccp-connection
      scriptType: pscore
      scriptPath: pipeline/Deploy-EnvironmentUpdates.ps1
      arguments: -DeploymentList "$(nprod_management)"

  #
  # Non-Production DataLynx Environment
  #
  - task: AzureCLI@2
    displayName: NPROD DataLynx Environment Validation
    inputs:
      azureSubscription: wh-np-ccp-connection
      scriptType: pscore
      scriptPath: pipeline/Validate-EnvironmentUpdates.ps1
      arguments: -DeploymentList "$(nprod_datalynx)"

  - task: AzureCLI@2
    displayName: NPROD DataLynx Environment Deployments
    timeoutInMinutes: 360
    inputs:
      azureSubscription: wh-np-ccp-connection
      scriptType: pscore
      scriptPath: pipeline/Deploy-EnvironmentUpdates.ps1
      arguments: -DeploymentList "$(nprod_datalynx)"

  #
  # Non-Production Data Science Environment
  #
  - task: AzureCLI@2
    displayName: NPROD Data Science Environment Validation
    inputs:
      azureSubscription: wh-np-ccp-connection
      scriptType: pscore
      scriptPath: pipeline/Validate-EnvironmentUpdates.ps1
      arguments: -DeploymentList "$(nprod_datascience)"

  - task: AzureCLI@2
    displayName: NPROD Data Science Environment Deployments
    timeoutInMinutes: 360
    inputs:
      azureSubscription: wh-np-ccp-connection
      scriptType: pscore
      scriptPath: pipeline/Deploy-EnvironmentUpdates.ps1
      arguments: -DeploymentList "$(nprod_datascience)"

  


#
# Production Deployment Job
#
- job: ProductionDeployment
  pool: wh-p-ccp-agents
  timeoutInMinutes: 720
  dependsOn: NprodDeployment
  steps:
  - task: PowerShell@2
    displayName: Identify State Changes
    inputs:
      pwsh: true
      targetType: filePath
      filePath: pipeline/Build-EnvironmentLists.ps1
      arguments: -Environments "prod_management"

  #
  # Production Management Plane Environment
  #
  - task: AzureCLI@2
    displayName: PRODUCTION Management Environment Validation
    inputs:
      azureSubscription: wh-p-ccp-connection
      scriptType: pscore
      scriptPath: pipeline/Validate-EnvironmentUpdates.ps1
      arguments: -DeploymentList "$(prod_management)"

  - task: AzureCLI@2
    displayName: PRODUCTION Management Environment Deployments
    timeoutInMinutes: 360
    inputs:
      azureSubscription: wh-p-ccp-connection
      scriptType: pscore
      scriptPath: pipeline/Deploy-EnvironmentUpdates.ps1
      arguments: -DeploymentList "$(prod_management)"
